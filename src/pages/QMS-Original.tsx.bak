import React, { useState, useEffect, useMemo } from 'react';
import {
  Activity,
  AlertTriangle,
  CheckCircle,
  Clock,
  FileText,
  TrendingUp,
  TrendingDown,
  BarChart3,
  PieChart,
  Users,
  Target,
  Calendar,
  Filter,
  Download,
  RefreshCw,
  ChevronRight,
  Sparkles,
  Package,
  AlertCircle,
  XCircle,
  Zap,
  X,
  Settings
} from 'lucide-react';
import { BRAND } from '../config/branding';
import { loadQMSData, type DeviationData as RealDeviationData, type CAPAData as RealCAPAData, type QMSMetrics } from '../services/qmsDataService';
// Import discovery utilities for debugging - available in browser console
import '../services/powerBIDiscovery';

interface QMSProps {
  onBack: () => void;
}

interface MetricCard {
  title: string;
  value: number | string;
  change?: number;
  changeLabel?: string;
  status?: 'success' | 'warning' | 'danger' | 'info';
  icon: React.ReactNode;
  subtitle?: string;
}

interface KPIDetails {
  title: string;
  value: number | string;
  description: string;
  breakdown: Array<{ label: string; value: number | string; percentage?: number }>;
  insights: string[];
  trends?: Array<{ period: string; value: number }>;
}

interface ActionDetails {
  priority: string;
  title: string;
  description: string;
  items: Array<{ id: string; title: string; assignee: string; dueDate: string; status: string }>;
  recommendations: string[];
}

export default function QMS({ onBack }: QMSProps) {
  const [timeRange, setTimeRange] = useState<'week' | 'month' | 'quarter' | 'year'>('month');
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'overview' | 'deviations' | 'capa' | 'investigations' | 'reports'>('overview');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [realMetrics, setRealMetrics] = useState<QMSMetrics | null>(null);
  const [realDeviations, setRealDeviations] = useState<RealDeviationData[]>([]);
  const [realCAPAs, setRealCAPAs] = useState<RealCAPAData[]>([]);
  const [lastUpdated, setLastUpdated] = useState<string>('');
  const [showKPIModal, setShowKPIModal] = useState(false);
  const [selectedKPI, setSelectedKPI] = useState<KPIDetails | null>(null);
  const [showActionModal, setShowActionModal] = useState(false);
  const [selectedAction, setSelectedAction] = useState<ActionDetails | null>(null);

  // Load real data from Power BI
  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        const data = await loadQMSData();
        setRealMetrics(data.metrics);
        setRealDeviations(data.deviations);
        setRealCAPAs(data.capas);
        setLastUpdated(data.lastUpdated);
      } catch (error) {
        console.error('Error loading QMS data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [timeRange]);

  // Metrics data from real Power BI data or defaults
  const metrics: MetricCard[] = useMemo(() => {
    const openDeviations = realDeviations.filter(d => d.status !== 'closed').length;
    
    return [
      {
        title: 'Total Deviations',
        value: realMetrics?.totalDeviations || 0,
        change: -8.2,
        changeLabel: 'vs last period',
        status: 'success',
        icon: <FileText className="h-5 w-5" />,
        subtitle: `${openDeviations} open`
      },
      {
        title: 'Open Items',
        value: realMetrics?.openItems || 0,
        change: 12.5,
        changeLabel: 'vs last period',
        status: realMetrics && realMetrics.openItems > 20 ? 'warning' : 'success',
        icon: <AlertTriangle className="h-5 w-5" />,
        subtitle: realDeviations.filter(d => d.status === 'overdue').length + ' overdue'
      },
      {
        title: 'On-Time Closure',
        value: `${realMetrics?.onTimeClosureRate.toFixed(1) || 0}%`,
        change: 3.7,
        changeLabel: 'improvement',
        status: realMetrics && realMetrics.onTimeClosureRate >= 90 ? 'success' : 'warning',
        icon: <CheckCircle className="h-5 w-5" />,
        subtitle: 'Target: 95%'
      },
      {
        title: 'Active CAPAs',
        value: realMetrics?.activeCAPAs || 0,
        change: -5.1,
        changeLabel: 'vs last period',
        status: 'info',
        icon: <Activity className="h-5 w-5" />,
        subtitle: realCAPAs.filter(c => {
          const dueDate = new Date(c.targetDate);
          const oneWeekFromNow = new Date();
          oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
          return dueDate <= oneWeekFromNow && c.status !== 'closed';
        }).length + ' due this week'
      },
      {
        title: 'Avg Closure Time',
        value: `${realMetrics?.avgClosureTime || 0} days`,
        change: -18.5,
        changeLabel: 'improvement',
        status: realMetrics && realMetrics.avgClosureTime <= 45 ? 'success' : 'warning',
        icon: <Clock className="h-5 w-5" />,
        subtitle: 'Target: 45 days'
      },
      {
        title: 'Compliance Score',
        value: `${realMetrics?.complianceScore.toFixed(1) || 0}%`,
        change: 1.2,
        changeLabel: 'improvement',
        status: realMetrics && realMetrics.complianceScore >= 95 ? 'success' : 'warning',
        icon: <Target className="h-5 w-5" />,
        subtitle: 'Industry: 94%'
      }
    ];
  }, [realMetrics, realDeviations, realCAPAs]);

  const filteredDeviations = useMemo(() => {
    return realDeviations.filter(dev => {
      const matchesStatus = filterStatus === 'all' || dev.status.toLowerCase() === filterStatus.toLowerCase();
      const matchesSearch = dev.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           dev.id.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           dev.assignee.toLowerCase().includes(searchQuery.toLowerCase()) ||
                           dev.department.toLowerCase().includes(searchQuery.toLowerCase());
      return matchesStatus && matchesSearch;
    });
  }, [realDeviations, filterStatus, searchQuery]);

  // Generate detailed KPI data for drill-through
  const getKPIDetails = (metricIndex: number): KPIDetails => {
    const metric = metrics[metricIndex];
    
    switch (metricIndex) {
      case 0: // Total Deviations
        const deviationsByStatus = realDeviations.reduce((acc, dev) => {
          acc[dev.status] = (acc[dev.status] || 0) + 1;
          return acc;
        }, {} as Record<string, number>);
        
        return {
          title: metric.title,
          value: metric.value,
          description: 'Total quality deviations tracked across all departments',
          breakdown: Object.entries(deviationsByStatus).map(([label, value]) => ({
            label: label.charAt(0).toUpperCase() + label.slice(1),
            value,
            percentage: Math.round((value / realDeviations.length) * 100)
          })),
          insights: [
            `${realDeviations.filter(d => d.priority === 'critical').length} critical priority deviations require immediate attention`,
            `${realDeviations.filter(d => d.status === 'closed').length} deviations successfully closed this period`,
            `Most common department: ${realDeviations.reduce((acc, d) => {
              acc[d.department] = (acc[d.department] || 0) + 1;
              return acc;
            }, {} as Record<string, number>) && Object.entries(realDeviations.reduce((acc, d) => {
              acc[d.department] = (acc[d.department] || 0) + 1;
              return acc;
            }, {} as Record<string, number>)).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A'}`,
            `Average resolution time: ${Math.round(realDeviations.filter(d => d.status === 'closed').length > 0 ? realDeviations.filter(d => d.status === 'closed').reduce((sum, d) => sum + Math.floor((new Date().getTime() - new Date(d.dateOpened).getTime()) / (1000 * 60 * 60 * 24)), 0) / realDeviations.filter(d => d.status === 'closed').length : 0)} days`
          ],
          trends: [
            { period: 'Week 1', value: 28 },
            { period: 'Week 2', value: 32 },
            { period: 'Week 3', value: 25 },
            { period: 'Week 4', value: Math.round(realMetrics?.totalDeviations || 0) }
          ]
        };
      
      case 1: // Open Items
        const overdueCount = realDeviations.filter(d => d.status === 'overdue').length;
        
        return {
          title: metric.title,
          value: metric.value,
          description: 'Currently open deviations and action items',
          breakdown: [
            { label: 'Critical Priority', value: realDeviations.filter(d => d.priority === 'critical' && d.status !== 'closed').length },
            { label: 'High Priority', value: realDeviations.filter(d => d.priority === 'high' && d.status !== 'closed').length },
            { label: 'Medium Priority', value: realDeviations.filter(d => d.priority === 'medium' && d.status !== 'closed').length },
            { label: 'Overdue', value: overdueCount, percentage: overdueCount > 0 ? Math.round((overdueCount / (realMetrics?.openItems || 1)) * 100) : 0 }
          ],
          insights: [
            `${overdueCount} items are currently overdue and need immediate attention`,
            `${realDeviations.filter(d => d.status === 'in-progress').length} items actively being worked on`,
            `${realDeviations.filter(d => {
              const dueDate = new Date(d.dueDate);
              const threeDaysFromNow = new Date();
              threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
              return dueDate <= threeDaysFromNow && d.status !== 'closed';
            }).length} items due within 3 days`,
            `Oldest open item: ${Math.max(...realDeviations.filter(d => d.status !== 'closed').map(d => Math.floor((Date.now() - new Date(d.dateOpened).getTime()) / (1000 * 60 * 60 * 24))))} days old`
          ]
        };
      
      case 2: // On-Time Closure
        return {
          title: metric.title,
          value: metric.value,
          description: 'Percentage of deviations closed within target timeframe',
          breakdown: [
            { label: 'On-Time Closures', value: `${Math.round((realMetrics?.onTimeClosureRate || 0))}%`, percentage: Math.round((realMetrics?.onTimeClosureRate || 0)) },
            { label: 'Late Closures', value: `${Math.round(100 - (realMetrics?.onTimeClosureRate || 0))}%`, percentage: Math.round(100 - (realMetrics?.onTimeClosureRate || 0)) },
            { label: 'Target Rate', value: '95%', percentage: 95 }
          ],
          insights: [
            `Currently ${(realMetrics?.onTimeClosureRate || 0) >= 95 ? 'exceeding' : 'below'} industry target of 95%`,
            `${Math.abs(Math.round((realMetrics?.onTimeClosureRate || 0) - 95))}% ${(realMetrics?.onTimeClosureRate || 0) >= 95 ? 'above' : 'below'} target`,
            `Improvement trend: ${metric.change || 0 > 0 ? 'positive' : 'needs attention'}`,
            `Top performing department consistently meets closure targets`
          ]
        };
      
      case 3: // Active CAPAs
        const capaByStatus = realCAPAs.reduce((acc, capa) => {
          acc[capa.status] = (acc[capa.status] || 0) + 1;
          return acc;
        }, {} as Record<string, number>);
        
        return {
          title: metric.title,
          value: metric.value,
          description: 'Corrective and Preventive Actions in progress',
          breakdown: Object.entries(capaByStatus).map(([label, value]) => ({
            label: label.charAt(0).toUpperCase() + label.slice(1).replace('-', ' '),
            value,
            percentage: Math.round((value / realCAPAs.length) * 100)
          })),
          insights: [
            `${realCAPAs.filter(c => (c.progress || 0) >= 80).length} CAPAs are 80%+ complete`,
            `${realCAPAs.filter(c => c.status === 'verified').length} CAPAs pending final verification`,
            `Average CAPA completion: ${Math.round(realCAPAs.reduce((sum, c) => sum + (c.progress || 0), 0) / realCAPAs.length)}%`,
            `${realCAPAs.filter(c => {
              const dueDate = new Date(c.targetDate);
              return dueDate <= new Date() && c.status !== 'closed';
            }).length} CAPAs past target date`
          ]
        };
      
      case 4: // Avg Closure Time
        return {
          title: metric.title,
          value: metric.value,
          description: 'Average time to close deviations and CAPAs',
          breakdown: [
            { label: 'Manufacturing', value: '10 days' },
            { label: 'Quality Control', value: '8 days' },
            { label: 'R&D', value: '15 days' },
            { label: 'Maintenance', value: '18 days' }
          ],
          insights: [
            `Target closure time: 45 days`,
            `Current performance is ${(realMetrics?.avgClosureTime || 0) <= 45 ? 'meeting' : 'not meeting'} target`,
            `Fastest department: Quality Control at 8 days average`,
            `${Math.abs(Math.round((realMetrics?.avgClosureTime || 0) - 45))} days ${(realMetrics?.avgClosureTime || 0) <= 45 ? 'better than' : 'over'} target`
          ]
        };
      
      case 5: // Compliance Score
        return {
          title: metric.title,
          value: metric.value,
          description: 'Overall quality management compliance rating',
          breakdown: [
            { label: 'Documentation', value: '98%', percentage: 98 },
            { label: 'Process Adherence', value: '97%', percentage: 97 },
            { label: 'Training Current', value: '95%', percentage: 95 },
            { label: 'Audit Readiness', value: '96%', percentage: 96 }
          ],
          insights: [
            `Industry average compliance: 94%`,
            `Currently ${((realMetrics?.complianceScore || 0) - 94).toFixed(1)}% above industry average`,
            `All critical compliance areas above 95%`,
            `Zero major audit findings in current period`
          ]
        };
      
      default:
        return {
          title: 'Unknown Metric',
          value: 0,
          description: '',
          breakdown: [],
          insights: []
        };
    }
  };

  const handleKPIClick = (metricIndex: number) => {
    const details = getKPIDetails(metricIndex);
    setSelectedKPI(details);
    setShowKPIModal(true);
  };

  const getActionDetails = (actionType: 'critical' | 'high' | 'medium'): ActionDetails => {
    switch (actionType) {
      case 'critical':
        const overdueDeviations = realDeviations.filter(d => d.status === 'overdue').slice(0, 3);
        return {
          priority: 'Critical',
          title: 'Address overdue deviations',
          description: 'These critical deviations are past their due date and require immediate action to maintain compliance.',
          items: overdueDeviations.map(d => ({
            id: d.id,
            title: d.title,
            assignee: d.assignee,
            dueDate: d.dueDate,
            status: d.status
          })),
          recommendations: [
            'Escalate to department heads for immediate resolution',
            'Allocate additional resources to expedite closure',
            'Schedule daily standup meetings for critical items',
            'Implement temporary containment measures if needed'
          ]
        };
      
      case 'high':
        const pendingCAPAs = realCAPAs.filter(c => c.status === 'in-progress').slice(0, 5);
        return {
          priority: 'High',
          title: 'Complete pending CAPA effectiveness checks',
          description: 'These CAPAs require effectiveness verification to ensure corrective actions are working as intended.',
          items: pendingCAPAs.map(c => ({
            id: c.id,
            title: c.title,
            assignee: c.assignee,
            dueDate: c.targetDate,
            status: c.status
          })),
          recommendations: [
            'Schedule effectiveness check reviews with quality team',
            'Gather supporting documentation for each CAPA',
            'Coordinate with affected departments for verification',
            'Prepare effectiveness metrics and data analysis'
          ]
        };
      
      case 'medium':
        const upcomingInvestigations = realDeviations.filter(d => {
          const dueDate = new Date(d.dueDate);
          const oneWeekFromNow = new Date();
          oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
          return dueDate <= oneWeekFromNow && d.status === 'in-progress';
        }).slice(0, 8);
        
        return {
          priority: 'Medium',
          title: 'Review investigations due this week',
          description: 'Active investigations that need review and potential escalation within the next 7 days.',
          items: upcomingInvestigations.map(d => ({
            id: d.id,
            title: d.title,
            assignee: d.assignee,
            dueDate: d.dueDate,
            status: d.status
          })),
          recommendations: [
            'Review investigation progress and findings',
            'Ensure all required documentation is complete',
            'Identify any resource constraints or blockers',
            'Plan for timely closure or deadline extension if needed'
          ]
        };
      
      default:
        return {
          priority: 'Unknown',
          title: '',
          description: '',
          items: [],
          recommendations: []
        };
    }
  };

  const handleActionClick = (actionType: 'critical' | 'high' | 'medium') => {
    const details = getActionDetails(actionType);
    setSelectedAction(details);
    setShowActionModal(true);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-slate-800">
      {/* Header */}
      <header className="sticky top-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200 dark:border-slate-700 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            {/* Back Button & Title */}
            <div className="flex items-center gap-4">
              <button
                onClick={onBack}
                className="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                style={{ color: BRAND.colors.primary }}
              >
                <ChevronRight className="h-5 w-5 rotate-180" />
              </button>
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white">
                  <Package className="h-6 w-6" />
                </div>
                <div>
                  <h1 className="text-xl font-bold text-slate-900 dark:text-white">
                    Quality Management System
                  </h1>
                  <p className="text-xs text-slate-600 dark:text-slate-400">
                    Real-time quality metrics & compliance dashboard
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content - Coming Soon */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div className="flex flex-col items-center justify-center min-h-[60vh] text-center">
          {/* Icon */}
          <div className="mb-8 p-8 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30">
            <Package className="h-24 w-24 text-blue-600 dark:text-blue-400" />
          </div>

          {/* Title */}
          <h2 className="text-4xl font-bold text-slate-900 dark:text-white mb-4">
            Coming Soon
          </h2>

          {/* Description */}
          <p className="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-2xl">
            The Quality Management System dashboard is currently under development.
            We're building an advanced real-time monitoring and compliance tracking system.
          </p>

          {/* Features Preview */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8 max-w-4xl">
            <div className="p-6 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-lg">
              <div className="flex items-center justify-center mb-4">
                <div className="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 text-white">
                  <CheckCircle className="h-8 w-8" />
                </div>
              </div>
              <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                Real-time Metrics
              </h3>
              <p className="text-sm text-slate-600 dark:text-slate-400">
                Live tracking of deviations, CAPAs, and compliance scores
              </p>
            </div>

            <div className="p-6 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-lg">
              <div className="flex items-center justify-center mb-4">
                <div className="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white">
                  <BarChart3 className="h-8 w-8" />
                </div>
              </div>
              <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                Advanced Analytics
              </h3>
              <p className="text-sm text-slate-600 dark:text-slate-400">
                Comprehensive dashboards and trend analysis
              </p>
            </div>

            <div className="p-6 rounded-2xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-lg">
              <div className="flex items-center justify-center mb-4">
                <div className="p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 text-white">
                  <AlertTriangle className="h-8 w-8" />
                </div>
              </div>
              <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                Smart Alerts
              </h3>
              <p className="text-sm text-slate-600 dark:text-slate-400">
                Automated notifications for critical quality events
              </p>
            </div>
          </div>

          {/* Status Badge */}
          <div className="mt-12 inline-flex items-center gap-2 px-6 py-3 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-medium shadow-lg">
            <Settings className="h-5 w-5 animate-spin" />
            <span>In Active Development</span>
          </div>
        </div>
      </main>
    </div>
  );
}

// Metric Card Component
function MetricCardComponent({ title, value, change, changeLabel, status, icon, subtitle }: MetricCard) {
// Metric Card Component
function MetricCardComponent({ title, value, change, changeLabel, status, icon, subtitle }: MetricCard) {
  const statusStyles = {
    success: 'from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-green-200 dark:border-green-800',
    warning: 'from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border-yellow-200 dark:border-yellow-800',
    danger: 'from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 border-red-200 dark:border-red-800',
    info: 'from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-blue-200 dark:border-blue-800'
  };

  const iconStyles = {
    success: 'from-green-500 to-emerald-600',
    warning: 'from-yellow-500 to-orange-600',
    danger: 'from-red-500 to-pink-600',
    info: 'from-blue-500 to-indigo-600'
  };

  return (
    <div className={`rounded-2xl bg-gradient-to-br ${statusStyles[status || 'info']} border-2 p-6 hover:shadow-xl transition-all group cursor-pointer`}>
      <div className="flex items-start justify-between mb-4">
        <div className={`p-3 rounded-xl bg-gradient-to-br ${iconStyles[status || 'info']} text-white shadow-lg group-hover:scale-110 transition-transform`}>
          {icon}
        </div>
        {change !== undefined && (
          <div className="flex items-center gap-1">
            {change > 0 ? (
              <TrendingUp className="h-4 w-4 text-green-600 dark:text-green-400" />
            ) : (
              <TrendingDown className="h-4 w-4 text-red-600 dark:text-red-400" />
            )}
            <span className={`text-sm font-bold ${
              change > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'
            }`}>
              {Math.abs(change)}%
            </span>
          </div>
        )}
      </div>
      
      <div className="text-3xl font-bold text-slate-900 dark:text-white mb-1">
        {value}
      </div>
      <div className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
        {title}
      </div>
      {subtitle && (
        <div className="text-xs text-slate-600 dark:text-slate-400">
          {subtitle}
        </div>
      )}
      {changeLabel && (
        <div className="text-xs text-slate-500 dark:text-slate-500 mt-2">
          {changeLabel}
        </div>
      )}
    </div>
  );
}

// Overview Tab
function OverviewTab({ onActionClick }: { onActionClick: (actionType: 'critical' | 'high' | 'medium') => void }) {
  return (
    <div className="space-y-6">
      {/* Charts Row */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
          <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <TrendingUp className="h-5 w-5 text-blue-600" />
            Deviation Trends
          </h3>
          <DeviationTrendChart />
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
          <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <PieChart className="h-5 w-5 text-purple-600" />
            Status Distribution
          </h3>
          <StatusDistributionChart />
        </div>
      </div>

      {/* Priority Actions */}
      <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
          <Zap className="h-5 w-5 text-yellow-600" />
          Priority Actions Required
        </h3>
        <PriorityActionsList onActionClick={onActionClick} />
      </div>

      {/* Department Performance */}
      <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
        <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
          <Users className="h-5 w-5 text-indigo-600" />
          Department Performance
        </h3>
        <DepartmentPerformanceTable />
      </div>
    </div>
  );
}

// Deviations Tab
function DeviationsTab({ 
  deviations, 
  searchQuery, 
  setSearchQuery, 
  filterStatus, 
  setFilterStatus 
}: {
  deviations: RealDeviationData[];
  searchQuery: string;
  setSearchQuery: (q: string) => void;
  filterStatus: string;
  setFilterStatus: (s: string) => void;
}) {
  return (
    <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
      {/* Filters */}
      <div className="mb-6 flex flex-col sm:flex-row gap-4">
        <div className="flex-1">
          <input
            type="text"
            placeholder="Search deviations..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 dark:text-white"
          />
        </div>
        <select
          value={filterStatus}
          onChange={(e) => setFilterStatus(e.target.value)}
          className="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-blue-500 dark:text-white"
        >
          <option value="all">All Status</option>
          <option value="open">Open</option>
          <option value="in progress">In Progress</option>
          <option value="closed">Closed</option>
          <option value="overdue">Overdue</option>
        </select>
      </div>

      {/* Deviations List */}
      <div className="space-y-3">
        {deviations.map((deviation) => (
          <DeviationCard key={deviation.id} deviation={deviation} />
        ))}
        {deviations.length === 0 && (
          <div className="text-center py-12 text-slate-500 dark:text-slate-400">
            <FileText className="h-12 w-12 mx-auto mb-3 opacity-50" />
            <p>No deviations found matching your criteria</p>
          </div>
        )}
      </div>
    </div>
  );
}

// Deviation Card
function DeviationCard({ deviation }: { deviation: RealDeviationData }) {
  const statusColors = {
    'open': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
    'in-progress': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
    'closed': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
    'overdue': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
  };

  const priorityColors = {
    'critical': 'bg-red-600 text-white',
    'high': 'bg-orange-600 text-white',
    'medium': 'bg-yellow-600 text-white',
    'low': 'bg-green-600 text-white'
  };

  return (
    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-xl hover:border-blue-400 dark:hover:border-blue-600 transition-all group">
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <span className="font-mono text-sm font-bold text-blue-600 dark:text-blue-400">{deviation.id}</span>
            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${priorityColors[deviation.priority] || priorityColors['medium']}`}>
              {deviation.priority}
            </span>
            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${statusColors[deviation.status] || statusColors['open']}`}>
              {deviation.status}
            </span>
          </div>
          <h4 className="font-semibold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
            {deviation.title}
          </h4>
        </div>
      </div>
      <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
        <span className="flex items-center gap-1">
          <Users className="h-4 w-4" />
          {deviation.assignee}
        </span>
        <span className="flex items-center gap-1">
          <Calendar className="h-4 w-4" />
          Due: {new Date(deviation.dueDate).toLocaleDateString()}
        </span>
        <span className="flex items-center gap-1">
          <Clock className="h-4 w-4" />
          {Math.floor((Date.now() - new Date(deviation.dateOpened).getTime()) / (1000 * 60 * 60 * 24))} days old
        </span>
        <span className="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded-lg">
          {deviation.department}
        </span>
      </div>
    </div>
  );
}

// CAPA Tab
function CAPATab({ capas }: { capas: RealCAPAData[] }) {
  return (
    <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
      <div className="space-y-4">
        {capas.map((capa) => (
          <CAPACard key={capa.id} capa={capa} />
        ))}
      </div>
    </div>
  );
}

// CAPA Card
function CAPACard({ capa }: { capa: RealCAPAData }) {
  const statusColors = {
    'open': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
    'in-progress': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
    'verified': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
    'closed': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300'
  };

  return (
    <div className="p-4 border border-slate-200 dark:border-slate-700 rounded-xl hover:border-purple-400 dark:hover:border-purple-600 transition-all">
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <span className="font-mono text-sm font-bold text-purple-600 dark:text-purple-400">{capa.id}</span>
            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${statusColors[capa.status] || statusColors['open']}`}>
              {capa.status}
            </span>
            <span className="text-xs text-slate-500 dark:text-slate-400">
              Dept: {capa.department}
            </span>
          </div>
          <h4 className="font-semibold text-slate-900 dark:text-white">
            {capa.title}
          </h4>
        </div>
      </div>
      <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400">
        <span className="flex items-center gap-1">
          <Users className="h-4 w-4" />
          {capa.assignee}
        </span>
        <span className="flex items-center gap-1">
          <Calendar className="h-4 w-4" />
          Due: {new Date(capa.targetDate).toLocaleDateString()}
        </span>
        {capa.progress && (
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <span className="text-xs">Progress:</span>
              <div className="flex-1 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-green-500 to-emerald-600"
                  style={{ width: `${capa.progress}%` }}
                />
              </div>
              <span className="text-xs font-bold">{capa.progress}%</span>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// Investigations Tab
function InvestigationsTab() {
  return (
    <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
      <div className="text-center py-12">
        <FileText className="h-16 w-16 mx-auto mb-4 text-slate-400" />
        <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">Investigations Module</h3>
        <p className="text-slate-600 dark:text-slate-400">Active investigations tracking coming soon</p>
      </div>
    </div>
  );
}

// Reports Tab
function ReportsTab() {
  return (
    <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
      <div className="text-center py-12">
        <PieChart className="h-16 w-16 mx-auto mb-4 text-slate-400" />
        <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-2">Reports & Analytics</h3>
        <p className="text-slate-600 dark:text-slate-400">Comprehensive reporting dashboard coming soon</p>
      </div>
    </div>
  );
}

// Simple Chart Components
function DeviationTrendChart() {
  const data = [45, 52, 38, 48, 55, 42, 39];
  const max = Math.max(...data);

  return (
    <div className="space-y-2">
      <div className="flex items-end justify-between h-48 gap-2">
        {data.map((value, i) => (
          <div key={i} className="flex-1 flex flex-col items-center gap-2">
            <div className="flex-1 w-full flex items-end">
              <div
                className="w-full bg-gradient-to-t from-blue-500 to-purple-600 rounded-t-lg transition-all hover:opacity-80"
                style={{ height: `${(value / max) * 100}%` }}
              />
            </div>
            <span className="text-xs text-slate-600 dark:text-slate-400">W{i + 1}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

function StatusDistributionChart() {
  const statuses = [
    { label: 'Open', value: 89, color: 'bg-blue-500' },
    { label: 'In Progress', value: 44, color: 'bg-yellow-500' },
    { label: 'Closed', value: 1114, color: 'bg-green-500' }
  ];
  const total = statuses.reduce((sum, s) => sum + s.value, 0);

  return (
    <div className="space-y-4">
      {statuses.map((status) => (
        <div key={status.label} className="space-y-1">
          <div className="flex items-center justify-between text-sm">
            <span className="font-medium text-slate-700 dark:text-slate-300">{status.label}</span>
            <span className="font-bold text-slate-900 dark:text-white">
              {status.value} ({Math.round((status.value / total) * 100)}%)
            </span>
          </div>
          <div className="h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
            <div
              className={`h-full ${status.color} transition-all`}
              style={{ width: `${(status.value / total) * 100}%` }}
            />
          </div>
        </div>
      ))}
    </div>
  );
}

function PriorityActionsList({ onActionClick }: { onActionClick: (actionType: 'critical' | 'high' | 'medium') => void }) {
  const actions = [
    { priority: 'critical' as const, text: 'Address 3 overdue deviations', count: 3, icon: <AlertCircle className="h-4 w-4" /> },
    { priority: 'high' as const, text: 'Complete 5 pending CAPA effectiveness checks', count: 5, icon: <Clock className="h-4 w-4" /> },
    { priority: 'medium' as const, text: 'Review 8 investigations due this week', count: 8, icon: <FileText className="h-4 w-4" /> }
  ];

  const priorityColors: Record<string, string> = {
    critical: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-700 dark:text-red-300',
    high: 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800 text-orange-700 dark:text-orange-300',
    medium: 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-700 dark:text-yellow-300'
  };

  return (
    <div className="space-y-3">
      {actions.map((action, i) => (
        <div
          key={i}
          onClick={() => onActionClick(action.priority)}
          className={`p-4 rounded-xl border-2 ${priorityColors[action.priority]} flex items-center justify-between hover:shadow-lg transition-all cursor-pointer`}
        >
          <div className="flex items-center gap-3">
            <div className="p-2 bg-white/50 dark:bg-black/20 rounded-lg">
              {action.icon}
            </div>
            <div>
              <span className="text-xs font-bold uppercase">{action.priority}</span>
              <p className="font-medium">{action.text}</p>
            </div>
          </div>
          <div className="text-2xl font-bold">{action.count}</div>
        </div>
      ))}
    </div>
  );
}

function DepartmentPerformanceTable() {
  const departments = [
    { name: 'Manufacturing', open: 23, closed: 156, onTime: 94.5, score: 'A' },
    { name: 'Quality Control', open: 18, closed: 142, onTime: 96.2, score: 'A+' },
    { name: 'R&D', open: 12, closed: 98, onTime: 92.1, score: 'A' },
    { name: 'Maintenance', open: 15, closed: 89, onTime: 88.7, score: 'B+' },
    { name: 'Warehouse', open: 8, closed: 67, onTime: 91.3, score: 'A-' }
  ];

  return (
    <div className="overflow-x-auto">
      <table className="w-full">
        <thead>
          <tr className="border-b-2 border-slate-200 dark:border-slate-700">
            <th className="text-left py-3 px-4 text-sm font-bold text-slate-700 dark:text-slate-300">Department</th>
            <th className="text-right py-3 px-4 text-sm font-bold text-slate-700 dark:text-slate-300">Open</th>
            <th className="text-right py-3 px-4 text-sm font-bold text-slate-700 dark:text-slate-300">Closed</th>
            <th className="text-right py-3 px-4 text-sm font-bold text-slate-700 dark:text-slate-300">On-Time %</th>
            <th className="text-center py-3 px-4 text-sm font-bold text-slate-700 dark:text-slate-300">Score</th>
          </tr>
        </thead>
        <tbody>
          {departments.map((dept, i) => (
            <tr key={i} className="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
              <td className="py-3 px-4 font-medium text-slate-900 dark:text-white">{dept.name}</td>
              <td className="py-3 px-4 text-right text-yellow-600 dark:text-yellow-400 font-semibold">{dept.open}</td>
              <td className="py-3 px-4 text-right text-green-600 dark:text-green-400 font-semibold">{dept.closed}</td>
              <td className="py-3 px-4 text-right">
                <span className={`font-semibold ${dept.onTime >= 95 ? 'text-green-600 dark:text-green-400' : dept.onTime >= 90 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'}`}>
                  {dept.onTime}%
                </span>
              </td>
              <td className="py-3 px-4 text-center">
                <span className="inline-block px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-sm font-bold rounded-lg">
                  {dept.score}
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// KPI Modal Component
function KPIModal({ kpi, onClose }: { kpi: KPIDetails; onClose: () => void }) {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        {/* Modal Header */}
        <div className="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
          <div>
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{kpi.title}</h2>
            <p className="text-sm text-slate-600 dark:text-slate-400 mt-1">{kpi.description}</p>
          </div>
          <button
            onClick={onClose}
            className="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
            aria-label="Close modal"
          >
            <X className="w-6 h-6 text-slate-600 dark:text-slate-400" />
          </button>
        </div>

        {/* Modal Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Main Metric */}
          <div className="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-6 text-center">
            <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">Current Value</p>
            <p className="text-5xl font-bold text-slate-900 dark:text-white">{kpi.value}</p>
          </div>

          {/* Trends */}
          {kpi.trends && kpi.trends.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-4">Trend Analysis</h3>
              <div className="flex items-end justify-between h-40 gap-3">
                {kpi.trends.map((trend, idx) => (
                  <div key={idx} className="flex-1 flex flex-col items-center gap-2">
                    <div className="flex-1 w-full flex items-end">
                      <div
                        className="w-full bg-gradient-to-t from-blue-500 to-purple-600 rounded-t-lg transition-all hover:opacity-80"
                        style={{ height: `${(trend.value / Math.max(...kpi.trends!.map(t => t.value))) * 100}%` }}
                      />
                    </div>
                    <span className="text-xs text-slate-600 dark:text-slate-400">{trend.period}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Breakdown */}
          {kpi.breakdown.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-4">Breakdown</h3>
              <div className="space-y-3">
                {kpi.breakdown.map((item, idx) => (
                  <div key={idx} className="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium text-slate-900 dark:text-white">{item.label}</span>
                      <div className="flex items-center gap-3">
                        <span className="text-sm text-slate-600 dark:text-slate-400">{item.value}</span>
                        {item.percentage !== undefined && (
                          <span className="text-sm font-semibold text-blue-600 dark:text-blue-400">{item.percentage}%</span>
                        )}
                      </div>
                    </div>
                    {item.percentage !== undefined && (
                      <div className="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                        <div 
                          className="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500"
                          style={{ width: `${item.percentage}%` }}
                        />
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Insights */}
          {kpi.insights.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-4">Key Insights</h3>
              <div className="grid gap-3">
                {kpi.insights.map((insight, idx) => (
                  <div key={idx} className="flex items-start gap-3 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
                    <div className="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0 mt-0.5">
                      <span className="text-xs font-bold text-blue-600 dark:text-blue-400">{idx + 1}</span>
                    </div>
                    <p className="text-sm text-slate-700 dark:text-slate-300">{insight}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Modal Footer */}
        <div className="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-6 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

// Action Modal Component  
function ActionModal({ action, onClose }: { action: ActionDetails; onClose: () => void }) {
  const priorityColors = {
    Critical: 'from-red-500 to-pink-600',
    High: 'from-orange-500 to-yellow-600',
    Medium: 'from-yellow-500 to-amber-600'
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        {/* Modal Header */}
        <div className={`bg-gradient-to-r ${priorityColors[action.priority as keyof typeof priorityColors]} p-6 text-white`}>
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2 mb-2">
                <span className="px-3 py-1 bg-white/20 rounded-lg text-sm font-bold uppercase backdrop-blur-sm">
                  {action.priority} Priority
                </span>
              </div>
              <h2 className="text-2xl font-bold">{action.title}</h2>
              <p className="text-white/90 mt-2">{action.description}</p>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-xl hover:bg-white/20 transition-colors"
              aria-label="Close modal"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        {/* Modal Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Action Items */}
          <div>
            <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <FileText className="h-5 w-5" />
              Action Items ({action.items.length})
            </h3>
            <div className="space-y-3">
              {action.items.map((item, idx) => (
                <div key={idx} className="p-4 border border-slate-200 dark:border-slate-700 rounded-xl hover:border-blue-400 dark:hover:border-blue-600 transition-all">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="font-mono text-sm font-bold text-blue-600 dark:text-blue-400">{item.id}</span>
                        <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                          {item.status}
                        </span>
                      </div>
                      <h4 className="font-medium text-slate-900 dark:text-white">{item.title}</h4>
                    </div>
                  </div>
                  <div className="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400 mt-3">
                    <span className="flex items-center gap-1">
                      <Users className="h-4 w-4" />
                      {item.assignee}
                    </span>
                    <span className="flex items-center gap-1">
                      <Calendar className="h-4 w-4" />
                      Due: {new Date(item.dueDate).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Recommendations */}
          {action.recommendations.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <Sparkles className="h-5 w-5 text-yellow-600" />
                Recommended Actions
              </h3>
              <div className="grid gap-3">
                {action.recommendations.map((rec, idx) => (
                  <div key={idx} className="flex items-start gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                    <div className="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center flex-shrink-0 mt-0.5">
                      <span className="text-xs font-bold">{idx + 1}</span>
                    </div>
                    <p className="text-sm text-slate-700 dark:text-slate-300">{rec}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Modal Footer */}
        <div className="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-6 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors font-medium"
          >
            Close
          </button>
          <button
            className="px-6 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:shadow-lg transition-all font-medium flex items-center gap-2"
          >
            <CheckCircle className="h-4 w-4" />
            Take Action
          </button>
        </div>
      </div>
    </div>
  );
}
